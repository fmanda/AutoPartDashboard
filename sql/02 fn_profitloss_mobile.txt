ALTER FUNCTION [dbo].[FN_PROFITLOSS_MOBILE](
	@START DATE,
	@END DATE
)RETURNS @RESULT TABLE(
	REPORTNAME VARCHAR(100),
	REPORTVAL FLOAT DEFAULT 0,
	REPORTGROUP INT, -- 1 NETSALES, 2 COGS, 3 EXPENSE, 4 OTHER INCOME, 5 NETPROFIT, 100,200,dst HEADER LV 1
	GROUPNAME VARCHAR(200),
	REPORTIDX INT
) AS
BEGIN
	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select 'INCOME',NULL, 100

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	SELECT 'Penjualan Kotor', SUM(ABS(A.QTY*A.HARGA)) AS GROSSALES, 100, 101
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 200 AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	SELECT 'Retur Penjualan', SUM(-1* (A.QTY*A.HARGA)) AS RETUR, 100, 102
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 250 AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	SELECT 'Diskon Penjualan', SUM((A.QTY*A.DISCOUNT)) AS DISC, 100, 103
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG in (200,250) AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	SELECT 'Pendapatan Jasa Service', SUM(QTY*(HARGA-DISCOUNT)), 100, 104
	FROM TSALESINVOICE A
	INNER JOIN TSERVICEDETAIL B ON A.ID = B.SALESINVOICE_ID
	WHERE A.TRANSDATE BETWEEN @START AND @END

	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select 'TOTAL INCOME',sum(reportval),100
	--from @RESULT where REPORTGROUP = 1



	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select 'COST OF GOOD SOLD',NULL, 200

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	SELECT 'Harga Pokok Penjualan', SUM(A.QTY*A.HARGAAVG)*-1, 200, 201
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG in (200,250) AND A.TRANSDATE BETWEEN @START AND @END

	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--SELECT 'Harga Pokok Adjustment', SUM(A.QTY*A.HARGAAVG)*-1, 2
	--FROM TTRANSDETAIL A
	--WHERE A.HEADER_FLAG = 500 AND A.TRANSDATE BETWEEN @START AND @END


	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select 'TOTAL COST OF GOOD SOLD',sum(reportval),200
	--from @RESULT where REPORTGROUP = 2

	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select NULL, NULL, NULL

	UPDATE @RESULT SET REPORTVAL = 0 WHERE REPORTVAL IS NULL;

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP ,REPORTIDX)
	select 'Gross Profit',
	(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 100)
	-(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 200)
	,250, 251


	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	select ''+B.NAMA,SUM(A.AMOUNT),300, 300 + ROW_NUMBER() OVER (ORDER BY B.NAMA) 
	FROM TFINANCIALTRANSACTION A
	INNER JOIN TACCOUNT B ON A.ACCOUNT_ID = B.ID	
	WHERE A.REKENING_ID IS NULL AND A.HEADER_FLAG = 500
	AND A.TRANSDATE BETWEEN @START AND @END
	GROUP BY B.NAMA

	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select 'TOTAL EXPENSE',sum(reportval),300
	--from @RESULT where REPORTGROUP = 3

	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select NULL, NULL, NULL

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	select ''+B.NAMA,SUM(A.AMOUNT),400, 400 + ROW_NUMBER() OVER (ORDER BY B.NAMA) 
	FROM TFINANCIALTRANSACTION A
	INNER JOIN TACCOUNT B ON A.ACCOUNT_ID = B.ID	
	WHERE A.REKENING_ID IS NULL AND A.HEADER_FLAG = 400
	AND A.TRANSDATE BETWEEN @START AND @END
	GROUP BY B.NAMA

	   	 
	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select NULL, NULL, NULL

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	SELECT 'STOCK ADJUSTMENT', SUM(A.QTY*A.HARGAAVG), 450, 451
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 500 AND A.TRANSDATE BETWEEN @START AND @END

	--INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	--select NULL, NULL, NULL

	UPDATE @RESULT SET REPORTVAL = 0 WHERE REPORTVAL IS NULL;

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP, REPORTIDX)
	select 'Net Profit',
	(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 100)
	-(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 200)
	-(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 300)
	-(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 400)
	+(select ISNULL(sum(reportval),0) from @RESULT where REPORTGROUP = 450)
	,500, 501


	UPDATE @RESULT SET GROUPNAME = 'Income' WHERE REPORTGROUP = 100;
	UPDATE @RESULT SET GROUPNAME = 'Cost Of Good Sold' WHERE REPORTGROUP = 200;
	UPDATE @RESULT SET GROUPNAME = 'Gross Profit' WHERE REPORTGROUP = 250;
	UPDATE @RESULT SET GROUPNAME = 'Expense' WHERE REPORTGROUP = 300;
	UPDATE @RESULT SET GROUPNAME = 'Other Income' WHERE REPORTGROUP = 400;
	UPDATE @RESULT SET GROUPNAME = 'Stock Adjustment' WHERE REPORTGROUP = 450;
	UPDATE @RESULT SET GROUPNAME = 'Net Profit' WHERE REPORTGROUP = 500;


	RETURN
END


